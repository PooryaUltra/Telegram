name: Build Telegram Blur Client

on:
  push:
    paths:
      - ".github/workflows/build-blur-client.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # آزاد کردن فضا (امن)
      - name: Super Cleanup to free disk
        run: |
          echo "Before cleanup:"
          df -h

          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android/sdk/emulator || true
          sudo rm -rf /usr/local/lib/android/sdk/system-images || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true

          echo "After cleanup:"
          df -h

      # نصب کنار تلگرام اصلی
      - name: Change APP_PACKAGE so it installs alongside official Telegram
        run: |
          if grep -q '^APP_PACKAGE=' gradle.properties; then
            sed -i 's/^APP_PACKAGE=.*/APP_PACKAGE=org.telegram.messenger.blurclient/' gradle.properties
          else
            echo 'APP_PACKAGE=org.telegram.messenger.blurclient' >> gradle.properties
          fi
          echo "Current APP_PACKAGE:"
          grep '^APP_PACKAGE=' gradle.properties || true

      # حذف google-services (Firebase)
      - name: Disable Google Services plugin
        run: |
          FILE="TMessagesProj_App/build.gradle"
          if [ -f "$FILE" ]; then
            sed -i "s/apply plugin: 'com.google.gms.google-services'//g" "$FILE"
            sed -i 's/apply plugin: \"com.google.gms.google-services\"//g' "$FILE"
          fi

      # بیلد تول 35 مشکل‌سازه
      - name: Patch buildToolsVersion to 34.0.0
        run: |
          for FILE in TMessagesProj_App/build.gradle TMessagesProj/build.gradle; do
            if [ -f "$FILE" ]; then
              sed -i "s/buildToolsVersion '35.0.0'/buildToolsVersion '34.0.0'/g" "$FILE" || true
              sed -i 's/buildToolsVersion "35.0.0"/buildToolsVersion "34.0.0"/g' "$FILE" || true
            fi
          done

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-35" "build-tools;34.0.0" "ndk;21.4.7075529"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # ---------- RenderEffect helper files ----------
      - name: Add RenderEffect blur helpers
        run: |
          set -euxo pipefail
          mkdir -p TMessagesProj/src/main/java/org/telegram/ui/blur

          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/BlurBubbleConfig.java << 'JAVA'
          package org.telegram.ui.blur;

          public final class BlurBubbleConfig {
              private BlurBubbleConfig() {}

              public static boolean enabled = true;
              public static boolean blurIncoming = true;
              public static boolean blurOutgoing = true;

              // RenderEffect radius in PX (Android 12+). Try 18..40
              public static float blurRadiusPx = 28f;

              // Bubble overlay alpha (0..1). Lower => more blur visible
              public static float overlayAlpha = 0.32f;

              public static boolean shouldBlurIncoming() { return enabled && blurIncoming; }
              public static boolean shouldBlurOutgoing() { return enabled && blurOutgoing; }

              public static float getBlurRadiusPx() { return blurRadiusPx; }
              public static float getOverlayAlpha() { return overlayAlpha; }
          }
          JAVA

          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/RealBlurBubbleHelper.java << 'JAVA'
          package org.telegram.ui.blur;

          import android.graphics.Bitmap;
          import android.graphics.Canvas;
          import android.graphics.Paint;
          import android.graphics.Rect;
          import android.graphics.RenderEffect;
          import android.graphics.Shader;
          import android.os.Build;
          import android.os.SystemClock;
          import android.view.View;

          import org.telegram.ui.ActionBar.Theme;

          import java.lang.ref.WeakReference;

          public final class RealBlurBubbleHelper {
              private static final Paint blurPaint = new Paint(Paint.ANTI_ALIAS_FLAG | Paint.FILTER_BITMAP_FLAG);

              private static Bitmap cacheBitmap;
              private static Canvas cacheCanvas;
              private static int cacheW, cacheH;
              private static long lastCaptureTime;
              private static WeakReference<View> lastViewRef = new WeakReference<>(null);

              private RealBlurBubbleHelper() {}

              private static boolean ensureCache(View v) {
                  int w = v.getWidth();
                  int h = v.getHeight();
                  if (w <= 0 || h <= 0) return false;

                  View last = lastViewRef.get();
                  if (cacheBitmap == null || cacheCanvas == null || w != cacheW || h != cacheH || last != v) {
                      cacheW = w;
                      cacheH = h;
                      cacheBitmap = Bitmap.createBitmap(cacheW, cacheH, Bitmap.Config.ARGB_8888);
                      cacheCanvas = new Canvas(cacheBitmap);
                      lastViewRef = new WeakReference<>(v);
                      lastCaptureTime = 0;
                  }
                  return true;
              }

              private static void captureIfNeeded(View v) {
                  long now = SystemClock.uptimeMillis();
                  if (now - lastCaptureTime < 33) return; // throttle ~30fps
                  lastCaptureTime = now;

                  cacheBitmap.eraseColor(0);
                  v.draw(cacheCanvas);
              }

              public static boolean drawBlurIntoBubble(
                      Canvas cellCanvas,
                      View parentView,
                      Rect bubbleBoundsInCell,
                      int bubbleAbsLeftInParent,
                      int bubbleAbsTopInParent,
                      Theme.MessageDrawable bubbleDrawable
              ) {
                  if (!BlurBubbleConfig.enabled) return false;
                  if (Build.VERSION.SDK_INT < Build.VERSION_CODES.S) return false;
                  if (parentView == null || bubbleDrawable == null || bubbleBoundsInCell == null) return false;
                  if (!ensureCache(parentView)) return false;

                  captureIfNeeded(parentView);

                  float r = BlurBubbleConfig.getBlurRadiusPx();
                  blurPaint.setRenderEffect(RenderEffect.createBlurEffect(r, r, Shader.TileMode.CLAMP));

                  Rect src = new Rect(
                          bubbleAbsLeftInParent,
                          bubbleAbsTopInParent,
                          bubbleAbsLeftInParent + bubbleBoundsInCell.width(),
                          bubbleAbsTopInParent + bubbleBoundsInCell.height()
                  );
                  Rect dst = new Rect(
                          bubbleBoundsInCell.left,
                          bubbleBoundsInCell.top,
                          bubbleBoundsInCell.right,
                          bubbleBoundsInCell.bottom
                  );

                  int save = cellCanvas.save();
                  try {
                      cellCanvas.clipPath(bubbleDrawable.makePath());
                      cellCanvas.drawBitmap(cacheBitmap, src, dst, blurPaint);
                  } finally {
                      cellCanvas.restoreToCount(save);
                  }
                  return true;
              }
          }
          JAVA

      # ---------- Patch ChatMessageCell by INSERT (نه replace) ----------
      - name: Patch ChatMessageCell (insert RenderEffect blur at bubble draw)
        run: |
          set -euxo pipefail
          python3 - <<'PY'
          import re, pathlib

          p = pathlib.Path("TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java")
          s = p.read_text(encoding="utf-8", errors="replace")

          # Add imports (once)
          if "org.telegram.ui.blur.RealBlurBubbleHelper" not in s:
              # put near other org.telegram.ui imports (safe anchor)
              anchor = "import org.telegram.ui.PhotoViewer;"
              if anchor in s:
                  s = s.replace(anchor, anchor + "\nimport org.telegram.ui.blur.BlurBubbleConfig;\nimport org.telegram.ui.blur.RealBlurBubbleHelper;")
              else:
                  # fallback: after package line
                  s = re.sub(r"(package\s+org\.telegram\.ui\.Cells;\s*)", r"\1\nimport org.telegram.ui.blur.BlurBubbleConfig;\nimport org.telegram.ui.blur.RealBlurBubbleHelper;\n", s, count=1)

          # If already patched, do nothing
          if "RealBlurBubbleHelper.drawBlurIntoBubble" in s:
              p.write_text(s, encoding="utf-8")
              print("Already patched.")
              raise SystemExit(0)

          # Insert blurDrawn + render blur BEFORE setAlpha/drawCached of background bubble
          # We target the exact stable sequence that exists in your file:
          #   currentSelectedBackgroundAlpha = 0;
          #   currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));
          #   currentBackgroundDrawable.drawCached(...)
          pat = re.compile(
              r"(currentSelectedBackgroundAlpha\s*=\s*0;\s*\n\s*)"
              r"(currentBackgroundDrawable\.setAlpha\(\(int\)\s*\(255\s*\*\s*alphaInternal\)\);\s*\n\s*)",
              re.M
          )

          repl = r"""\1boolean blurDrawn = false;
                if (BlurBubbleConfig.enabled && getParent() instanceof android.view.View && currentBackgroundDrawable != null) {
                    android.view.View parentView = (android.view.View) getParent();
                    boolean isOutgoing = currentMessageObject != null && currentMessageObject.isOutOwner();
                    boolean shouldBlur = isOutgoing ? BlurBubbleConfig.shouldBlurOutgoing() : BlurBubbleConfig.shouldBlurIncoming();
                    if (shouldBlur) {
                        android.graphics.Rect bounds = currentBackgroundDrawable.getBounds();
                        int absLeft = bounds.left + getLeft();
                        int absTop  = bounds.top  + getTop();
                        blurDrawn = RealBlurBubbleHelper.drawBlurIntoBubble(
                                canvas,
                                parentView,
                                bounds,
                                absLeft,
                                absTop,
                                currentBackgroundDrawable
                        );
                    }
                }
                if (blurDrawn) {
                    alphaInternal *= BlurBubbleConfig.getOverlayAlpha();
                }
                \2"""

          s2, n = pat.subn(repl, s, count=1)
          if n == 0:
              raise SystemExit("Patch failed: could not find the alpha/setAlpha anchor in ChatMessageCell.java")

          p.write_text(s2, encoding="utf-8")
          print("Patched ChatMessageCell OK")
          PY

      - name: Build afatRelease APK (universal)
        run: ./gradlew :TMessagesProj_App:assembleAfatRelease --no-daemon --stacktrace

      - name: Upload universal APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-universal
          path: "**/afat/release/*.apk"
          if-no-files-found: error
