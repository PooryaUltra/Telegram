name: Android CI Build (Telegram)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # ⚠️ HARDCODED – keep repo PRIVATE
      TELEGRAM_API_ID: "26931698"
      TELEGRAM_API_HASH: "859d6678660fc4b6bb04f7135d4329a2"
      GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g -Dfile.encoding=UTF-8"
      JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF-8"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Show disk usage (before)
        shell: bash
        run: |
          df -h
          free -h

      - name: Free disk space
        shell: bash
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Gradle (extra cache)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false

      - name: Make gradlew executable
        shell: bash
        run: chmod +x ./gradlew

      - name: Write local.properties (Telegram API keys)
        shell: bash
        run: |
          rm -f local.properties
          cat > local.properties <<EOF
          telegram.api_id=${TELEGRAM_API_ID}
          telegram.api_hash=${TELEGRAM_API_HASH}
          EOF
          echo "local.properties created:"
          cat local.properties

      - name: Gradle info
        shell: bash
        run: |
          ./gradlew --version
          java -version

      - name: Clean
        shell: bash
        run: |
          ./gradlew --no-daemon clean

      - name: Build (Afat Release)
        shell: bash
        run: |
          set -o pipefail
          ./gradlew --no-daemon --stacktrace --info :TMessagesProj_App:assembleAfatRelease | tee build.log

      - name: Upload APKs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-APKs
          path: |
            **/build/outputs/apk/**/*.apk
            **/build/outputs/**/*.apk
          if-no-files-found: error

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build.log
            **/*.log
          if-no-files-found: warn
