name: Build Telegram Blur Bubbles

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # مستقیم گذاشتی (طبق درخواستت)
      TG_API_ID: "123456"
      TG_API_HASH: "0123456789abcdef0123456789abcdef"

      BLUR_RADIUS: "22"      # قابل تنظیم
      TINT_ALPHA: "0.42"     # قابل تنظیم

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3

      - name: Patch sources (add blur + set api id/hash)
        shell: bash
        run: |
          set -euo pipefail

          python3 - << 'PY'
          import os, re
          from pathlib import Path

          api_id = os.environ["TG_API_ID"]
          api_hash = os.environ["TG_API_HASH"]

          blur_radius = os.environ.get("BLUR_RADIUS", "22")
          tint_alpha = os.environ.get("TINT_ALPHA", "0.42")

          root = Path(".").resolve()

          # ---- 1) Write/overwrite BubbleBackdropBlur.java (idempotent) ----
          target = root / "TMessagesProj/src/main/java/org/telegram/ui/Components/BubbleBackdropBlur.java"
          target.parent.mkdir(parents=True, exist_ok=True)

          code = f'''package org.telegram.ui.Components;

          import android.graphics.*;
          import android.os.Build;
          import android.graphics.RenderEffect;
          import android.graphics.Shader;

          // AUTO-PATCH: BLUR_BUBBLES_V1
          public final class BubbleBackdropBlur {{
              private final Paint blurPaint = new Paint(Paint.ANTI_ALIAS_FLAG | Paint.FILTER_BITMAP_FLAG);
              private final Paint tintPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
              private Bitmap lastWallpaper;
              private Bitmap cachedCrop;
              private final Rect lastRect = new Rect();
              private float lastRadius;

              public void draw(Canvas canvas, Bitmap wallpaper, Rect bubbleRect, Path bubblePath,
                               int bubbleThemeColor, float tintAlpha, float blurRadius) {{
                  if (wallpaper == null || bubbleRect == null || bubblePath == null) return;

                  Rect src = new Rect(
                          Math.max(0, bubbleRect.left),
                          Math.max(0, bubbleRect.top),
                          Math.min(wallpaper.getWidth(), bubbleRect.right),
                          Math.min(wallpaper.getHeight(), bubbleRect.bottom)
                  );
                  if (src.width() <= 2 || src.height() <= 2) return;

                  boolean needRebuild =
                          cachedCrop == null ||
                          lastWallpaper != wallpaper ||
                          !lastRect.equals(src) ||
                          lastRadius != blurRadius;

                  if (needRebuild) {{
                      if (cachedCrop != null) cachedCrop.recycle();
                      cachedCrop = Bitmap.createBitmap(wallpaper, src.left, src.top, src.width(), src.height());
                      lastWallpaper = wallpaper;
                      lastRect.set(src);
                      lastRadius = blurRadius;

                      if (Build.VERSION.SDK_INT >= 31) {{
                          blurPaint.setRenderEffect(RenderEffect.createBlurEffect(
                                  blurRadius, blurRadius, Shader.TileMode.CLAMP
                          ));
                      }} else {{
                          blurPaint.setRenderEffect(null);
                      }}
                  }}

                  int save = canvas.save();
                  canvas.clipPath(bubblePath);

                  Rect dst = new Rect(bubbleRect.left, bubbleRect.top,
                          bubbleRect.left + src.width(), bubbleRect.top + src.height());
                  canvas.drawBitmap(cachedCrop, null, dst, blurPaint);

                  int a = Math.round(255f * Math.max(0f, Math.min(1f, tintAlpha)));
                  tintPaint.setColor((bubbleThemeColor & 0x00FFFFFF) | (a << 24));
                  canvas.drawRect(dst, tintPaint);

                  canvas.restoreToCount(save);
              }}

              public void release() {{
                  if (cachedCrop != null) {{
                      cachedCrop.recycle();
                      cachedCrop = null;
                  }}
                  lastWallpaper = null;
              }}
          }}
          '''
          target.write_text(code, encoding="utf-8")
          print("Wrote:", target)

          # ---- 2) Set API ID/HASH in BuildVars.java (best-effort, version tolerant) ----
          buildvars = root / "TMessagesProj/src/main/java/org/telegram/messenger/BuildVars.java"
          if not buildvars.exists():
              raise SystemExit(f"BuildVars.java not found at {buildvars}")

          txt = buildvars.read_text(encoding="utf-8")

          # Try common patterns:
          # public static int APP_ID = ...;
          # public static String APP_HASH = "...";
          txt2 = re.sub(r'(public\\s+static\\s+int\\s+APP_ID\\s*=\\s*)\\d+(\\s*;)', r'\\g<1>' + api_id + r'\\2', txt)
          txt2 = re.sub(r'(public\\s+static\\s+String\\s+APP_HASH\\s*=\\s*)".*?"(\\s*;)', r'\\g<1>"' + api_hash + r'"\\2', txt2)

          if txt2 == txt:
              # fallback: maybe "APP_ID = BuildConfig..." etc. We inject if not present.
              if "APP_ID" not in txt or "APP_HASH" not in txt:
                  raise SystemExit("Could not find APP_ID/APP_HASH in BuildVars.java to patch.")
              else:
                  # still write in case formatting differs
                  pass

          buildvars.write_text(txt2, encoding="utf-8")
          print("Patched:", buildvars)

          # ---- 3) Patch ChatMessageCell (insert hooks; markers make it idempotent) ----
          cell = root / "TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java"
          if not cell.exists():
              raise SystemExit(f"ChatMessageCell.java not found at {cell}")

          c = cell.read_text(encoding="utf-8")

          if "AUTO-PATCH: BLUR_BUBBLES_V1" not in c:
              # Insert field near other fields
              c = re.sub(
                  r'(public\\s+class\\s+ChatMessageCell\\s+.*?\\{)',
                  r'\\1\\n\\n    // AUTO-PATCH: BLUR_BUBBLES_V1\\n    private final org.telegram.ui.Components.BubbleBackdropBlur bubbleBlur = new org.telegram.ui.Components.BubbleBackdropBlur();\\n',
                  c,
                  count=1,
                  flags=re.S
              )

              # Insert draw call: best-effort injection near where bubble background is drawn.
              # We search for a common method "onDraw" and inject a clearly marked block near its start.
              m = re.search(r'protected\\s+void\\s+onDraw\\s*\\(Canvas\\s+canvas\\)\\s*\\{', c)
              if not m:
                  raise SystemExit("Could not find onDraw(Canvas canvas) in ChatMessageCell.java")

              insert = f'''
                  // AUTO-PATCH: BLUR_BUBBLES_V1_DRAW
                  // NOTE: You must map these placeholders to real variables in your source:
                  // - wallpaperBitmap: Bitmap of current chat wallpaper
                  // - bubbleRect: Rect bounds of current bubble on canvas
                  // - bubblePath: Path of current bubble shape
                  // - bubbleColor: int theme bubble color (incoming/outgoing)
                  // The hook below is placed early; move it to the exact bubble draw spot if needed.

                  // Bitmap wallpaperBitmap = ...;
                  // Rect bubbleRect = ...;
                  // Path bubblePath = ...;
                  // int bubbleColor = ...;
                  // bubbleBlur.draw(canvas, wallpaperBitmap, bubbleRect, bubblePath, bubbleColor, {tint_alpha}f, {float(blur_radius)}f);
              '''
              # Inject right after onDraw opening brace
              idx = m.end()
              c = c[:idx] + insert + c[idx:]

              cell.write_text(c, encoding="utf-8")
              print("Patched:", cell)
          else:
              print("ChatMessageCell already patched (marker found).")

          print("Done.")
          PY

      - name: Build (Gradle)
        run: |
          chmod +x ./gradlew
          ./gradlew :TMessagesProj:assembleRelease --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: telegram-blur-bubbles-apk
          path: |
            TMessagesProj/build/outputs/apk/release/*.apk
