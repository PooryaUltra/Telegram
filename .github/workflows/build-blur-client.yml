name: Build Telegram Blur Client

on:
  push:
    paths:
      - ".github/workflows/build-blur-client.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free Disk Space (safe)
        shell: bash
        run: |
          set -euxo pipefail
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android/sdk/emulator || true
          sudo rm -rf /usr/local/lib/android/sdk/system-images || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Apply Real Blur patches (robust)
        shell: bash
        run: |
          set -euxo pipefail

          mkdir -p TMessagesProj/src/main/java/org/telegram/ui/blur

          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/BlurBubbleConfig.java <<'JAVA'
          package org.telegram.ui.blur;

          public final class BlurBubbleConfig {
              private BlurBubbleConfig() {}

              public static boolean blurEnabled = true;
              public static boolean blurIncoming = true;
              public static boolean blurOutgoing = true;

              // RenderEffect radius is in PX
              public static float blurRadiusPx = 26f;

              // How opaque the normal bubble is on top of blur (0..1)
              public static float overlayAlpha = 0.30f;

              public static boolean shouldBlurIncoming() { return blurEnabled && blurIncoming; }
              public static boolean shouldBlurOutgoing() { return blurEnabled && blurOutgoing; }

              public static float getBlurRadiusPx() { return blurRadiusPx; }
              public static float getOverlayAlpha() { return overlayAlpha; }
          }
          JAVA

          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/RealBlurBubbleHelper.java <<'JAVA'
          package org.telegram.ui.blur;

          import android.graphics.Bitmap;
          import android.graphics.Canvas;
          import android.graphics.Paint;
          import android.graphics.Rect;
          import android.graphics.RenderEffect;
          import android.graphics.Shader;
          import android.os.Build;
          import android.os.SystemClock;
          import android.view.View;

          import org.telegram.ui.ActionBar.Theme;

          import java.lang.ref.WeakReference;

          public final class RealBlurBubbleHelper {

              private static final Paint blurPaint = new Paint(Paint.ANTI_ALIAS_FLAG | Paint.FILTER_BITMAP_FLAG);
              private static Bitmap cacheBitmap;
              private static Canvas cacheCanvas;
              private static int cacheW, cacheH;
              private static long lastCaptureTime;
              private static WeakReference<View> lastViewRef = new WeakReference<>(null);

              private RealBlurBubbleHelper() {}

              private static boolean ensureCache(View v) {
                  int w = v.getWidth();
                  int h = v.getHeight();
                  if (w <= 0 || h <= 0) return false;

                  View last = lastViewRef.get();
                  if (cacheBitmap == null || cacheCanvas == null || w != cacheW || h != cacheH || last != v) {
                      cacheW = w;
                      cacheH = h;
                      cacheBitmap = Bitmap.createBitmap(cacheW, cacheH, Bitmap.Config.ARGB_8888);
                      cacheCanvas = new Canvas(cacheBitmap);
                      lastViewRef = new WeakReference<>(v);
                      lastCaptureTime = 0;
                  }
                  return true;
              }

              private static void captureIfNeeded(View v) {
                  long now = SystemClock.uptimeMillis();
                  if (now - lastCaptureTime < 33) return; // ~30fps throttle
                  lastCaptureTime = now;

                  cacheBitmap.eraseColor(0);
                  v.draw(cacheCanvas);
              }

              public static boolean drawBlurIntoBubble(
                      Canvas cellCanvas,
                      View parentView,
                      Rect bubbleBoundsInCell,
                      int bubbleAbsLeft,
                      int bubbleAbsTop,
                      Theme.MessageDrawable bubbleDrawable
              ) {
                  if (!BlurBubbleConfig.blurEnabled) return false;
                  if (Build.VERSION.SDK_INT < Build.VERSION_CODES.S) return false;
                  if (parentView == null || bubbleDrawable == null || bubbleBoundsInCell == null) return false;
                  if (!ensureCache(parentView)) return false;

                  captureIfNeeded(parentView);

                  float r = BlurBubbleConfig.getBlurRadiusPx();
                  blurPaint.setRenderEffect(RenderEffect.createBlurEffect(r, r, Shader.TileMode.CLAMP));

                  Rect src = new Rect(
                          bubbleAbsLeft,
                          bubbleAbsTop,
                          bubbleAbsLeft + bubbleBoundsInCell.width(),
                          bubbleAbsTop + bubbleBoundsInCell.height()
                  );

                  Rect dst = new Rect(
                          bubbleBoundsInCell.left,
                          bubbleBoundsInCell.top,
                          bubbleBoundsInCell.right,
                          bubbleBoundsInCell.bottom
                  );

                  int save = cellCanvas.save();
                  try {
                      cellCanvas.clipPath(bubbleDrawable.makePath());
                      cellCanvas.drawBitmap(cacheBitmap, src, dst, blurPaint);
                  } finally {
                      cellCanvas.restoreToCount(save);
                  }
                  return true;
              }
          }
          JAVA

          python3 - <<'PY'
          import re, pathlib

          p = pathlib.Path("TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java")
          s = p.read_text(encoding="utf-8", errors="replace")

          # 1) Ensure imports exist (add near other org.telegram.ui imports)
          if "org.telegram.ui.blur.RealBlurBubbleHelper" not in s:
              s = s.replace(
                  "import org.telegram.ui.PhotoViewer;",
                  "import org.telegram.ui.PhotoViewer;\nimport org.telegram.ui.blur.BlurBubbleConfig;\nimport org.telegram.ui.blur.RealBlurBubbleHelper;"
              )

          # 2) Replace ANY existing blur block (Nekogram or our earlier injections) robustly
          # Try 2 patterns:
          # A) With markers
          marker_pat = re.compile(r"//\s*.*?Blur\s+Bubbles.*?End\s+.*?Blur\s+Bubbles", re.S)
          # B) Without markers: from 'boolean blurDrawn = false;' up to the next blank line after it
          fallback_pat = re.compile(r"\n\s*boolean\s+blurDrawn\s*=\s*false\s*;.*?\n\s*(?=\n\s*\w|\n\s*if|\n\s*//|\n\s*currentSelectedBackgroundAlpha)", re.S)

          repl = r"""
              // Real Blur Bubbles (RenderEffect, Android 12+)
              boolean blurDrawn = false;
              if (BlurBubbleConfig.blurEnabled && getParent() instanceof android.view.View && currentBackgroundDrawable != null) {
                  android.view.View parentView = (android.view.View) getParent();
                  boolean isOutgoing = currentMessageObject != null && currentMessageObject.isOutOwner();
                  boolean shouldBlur = isOutgoing ? BlurBubbleConfig.shouldBlurOutgoing() : BlurBubbleConfig.shouldBlurIncoming();
                  if (shouldBlur) {
                      android.graphics.Rect bounds = currentBackgroundDrawable.getBounds();
                      int absLeft = bounds.left + getLeft();
                      int absTop  = bounds.top  + getTop();
                      blurDrawn = RealBlurBubbleHelper.drawBlurIntoBubble(
                          canvas,
                          parentView,
                          bounds,
                          absLeft,
                          absTop,
                          currentBackgroundDrawable
                      );
                  }
              }
              // End Real Blur Bubbles
          """

          replaced = False

          # Prefer replacing the Nekogram helper call if it exists
          if "BlurBubbleHelper.drawBlurBubble" in s or "BlurBubbleHelper.blurEnabled" in s:
              # Replace the whole region that contains the helper call (best-effort)
              block_pat = re.compile(r"(\s*//.*?Blur.*?Bubbles.*?\n)?\s*boolean\s+blurDrawn\s*=\s*false\s*;.*?BlurBubbleHelper\.drawBlurBubble.*?\n.*?(//\s*End.*?Bubbles.*?\n)?", re.S)
              s2, n = block_pat.subn(repl, s, count=1)
              if n:
                  s = s2
                  replaced = True

          if not replaced:
              # Try marker region
              s2, n = marker_pat.subn(repl, s, count=1)
              if n:
                  s = s2
                  replaced = True

          if not replaced:
              # Try fallback
              s2, n = fallback_pat.subn("\n"+repl+"\n", s, count=1)
              if n:
                  s = s2
                  replaced = True

          if not replaced:
              raise SystemExit("Could not find a blur block to replace (no markers / no blurDrawn).")

          # 3) Inject overlay alpha right before setAlpha(255 * alphaInternal) (first occurrence only)
          alpha_line = "currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));"
          idx = s.find(alpha_line)
          if idx == -1:
              raise SystemExit("Could not find currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));")

          inject = "if (blurDrawn) { alphaInternal *= BlurBubbleConfig.getOverlayAlpha(); }\n                "
          s = s.replace(alpha_line, inject + alpha_line, 1)

          p.write_text(s, encoding="utf-8")
          print("ChatMessageCell patched OK")
          PY

      - name: Build APK (afatRelease)
        shell: bash
        run: |
          set -euxo pipefail
          ./gradlew --no-daemon :TMessagesProj_App:assembleAfatRelease

      - name: Upload universal APK
        uses: actions/upload-artifact@v4
        with:
          name: TelegramBlur-universal
          path: "**/afat/release/*.apk"
          if-no-files-found: error
