name: Build Telegram Blur Client

on:
  push:
    paths:
      - ".github/workflows/build-blur-client.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free Disk Space (safe)
        shell: bash
        run: |
          set -euxo pipefail
          echo "Before cleanup:"
          df -h

          # Remove big preinstalled toolchains we don't need
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android/sdk/emulator || true
          sudo rm -rf /usr/local/lib/android/sdk/system-images || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/hostedtoolcache/go || true
          sudo rm -rf /opt/hostedtoolcache/Python || true

          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo "After cleanup:"
          df -h

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      # ---- PATCH: add Real blur helper + config, and patch ChatMessageCell ----
      - name: Apply Real Blur patches
        shell: bash
        run: |
          set -euxo pipefail

          # 1) Create helper package directory
          mkdir -p TMessagesProj/src/main/java/org/telegram/ui/blur

          # 2) Write BlurBubbleConfig.java
          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/BlurBubbleConfig.java <<'JAVA'
          package org.telegram.ui.blur;

          public final class BlurBubbleConfig {
              private BlurBubbleConfig() {}

              // Enable switches (later you can wire these to SharedPreferences / UI settings)
              public static boolean blurEnabled = true;
              public static boolean blurIncoming = true;
              public static boolean blurOutgoing = true;

              // Blur radius in px (RenderEffect uses pixels, not dp). Good default for modern phones.
              // If you want stronger blur: 28..40
              public static float blurRadiusPx = 24f;

              // How opaque the original bubble color should be drawn over the blur (0..1)
              // Lower => more blur visible, Higher => more like normal Telegram bubble
              public static float overlayAlpha = 0.35f;

              public static boolean shouldBlurIncoming() { return blurEnabled && blurIncoming; }
              public static boolean shouldBlurOutgoing() { return blurEnabled && blurOutgoing; }

              public static float getBlurRadiusPx() { return blurRadiusPx; }
              public static float getOverlayAlpha() { return overlayAlpha; }
          }
          JAVA

          # 3) Write RealBlurBubbleHelper.java
          cat > TMessagesProj/src/main/java/org/telegram/ui/blur/RealBlurBubbleHelper.java <<'JAVA'
          package org.telegram.ui.blur;

          import android.graphics.Bitmap;
          import android.graphics.Canvas;
          import android.graphics.Paint;
          import android.graphics.Rect;
          import android.graphics.RenderEffect;
          import android.graphics.Shader;
          import android.os.Build;
          import android.os.SystemClock;
          import android.view.View;

          import org.telegram.ui.ActionBar.Theme;

          import java.lang.ref.WeakReference;

          public final class RealBlurBubbleHelper {

              private static final Paint blurPaint = new Paint(Paint.ANTI_ALIAS_FLAG | Paint.FILTER_BITMAP_FLAG);
              private static Bitmap cacheBitmap;
              private static Canvas cacheCanvas;
              private static int cacheW, cacheH;
              private static long lastCaptureTime;
              private static WeakReference<View> lastViewRef = new WeakReference<>(null);

              private RealBlurBubbleHelper() {}

              private static boolean ensureCache(View v) {
                  int w = v.getWidth();
                  int h = v.getHeight();
                  if (w <= 0 || h <= 0) return false;

                  View last = lastViewRef.get();
                  if (cacheBitmap == null || cacheCanvas == null || w != cacheW || h != cacheH || last != v) {
                      cacheW = w;
                      cacheH = h;
                      cacheBitmap = Bitmap.createBitmap(cacheW, cacheH, Bitmap.Config.ARGB_8888);
                      cacheCanvas = new Canvas(cacheBitmap);
                      lastViewRef = new WeakReference<>(v);
                      lastCaptureTime = 0;
                  }
                  return true;
              }

              private static void captureIfNeeded(View v) {
                  // throttle to reduce cost while scrolling
                  long now = SystemClock.uptimeMillis();
                  if (now - lastCaptureTime < 33) {
                      return;
                  }
                  lastCaptureTime = now;

                  // clear
                  cacheBitmap.eraseColor(0);

                  // draw parent into bitmap
                  v.draw(cacheCanvas);
              }

              public static boolean drawBlurIntoBubble(
                      Canvas cellCanvas,
                      View parentView,
                      Rect bubbleBoundsInCell,
                      int bubbleAbsLeft,
                      int bubbleAbsTop,
                      Theme.MessageDrawable bubbleDrawable
              ) {
                  if (!BlurBubbleConfig.blurEnabled) return false;
                  if (Build.VERSION.SDK_INT < Build.VERSION_CODES.S) return false; // RenderEffect

                  if (parentView == null || bubbleDrawable == null || bubbleBoundsInCell == null) return false;
                  if (!ensureCache(parentView)) return false;

                  captureIfNeeded(parentView);

                  // Prepare RenderEffect
                  float r = BlurBubbleConfig.getBlurRadiusPx();
                  blurPaint.setRenderEffect(RenderEffect.createBlurEffect(r, r, Shader.TileMode.CLAMP));

                  // src rect in parent coordinates
                  Rect src = new Rect(
                          bubbleAbsLeft,
                          bubbleAbsTop,
                          bubbleAbsLeft + bubbleBoundsInCell.width(),
                          bubbleAbsTop + bubbleBoundsInCell.height()
                  );

                  // dst rect in cell coordinates
                  Rect dst = new Rect(
                          bubbleBoundsInCell.left,
                          bubbleBoundsInCell.top,
                          bubbleBoundsInCell.right,
                          bubbleBoundsInCell.bottom
                  );

                  int save = cellCanvas.save();
                  // Clip to bubble shape (so blur stays inside the bubble)
                  cellCanvas.clipPath(bubbleDrawable.makePath());

                  // Draw blurred bitmap region into bubble
                  cellCanvas.drawBitmap(cacheBitmap, src, dst, blurPaint);

                  cellCanvas.restoreToCount(save);

                  return true;
              }
          }
          JAVA

          # 4) Patch ChatMessageCell.java (replace the Nekogram blur block with real RenderEffect blur)
          python3 - <<'PY'
          import re, pathlib

          p = pathlib.Path("TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java")
          s = p.read_text(encoding="utf-8")

          # Ensure imports exist
          if "org.telegram.ui.blur.RealBlurBubbleHelper" not in s:
              s = s.replace(
                  "import org.telegram.ui.PhotoViewer;",
                  "import org.telegram.ui.PhotoViewer;\nimport org.telegram.ui.blur.BlurBubbleConfig;\nimport org.telegram.ui.blur.RealBlurBubbleHelper;"
              )

          # Replace the existing Nekogram blur block (it currently draws blur but then draws opaque bubble over it)
          pattern = re.compile(r"""
              \s*//\s*Nekogram\s+Blur\s+Bubbles\s*-\s*Draw\s+blur\s+effect.*?
              \s*//\s*End\s+Nekogram\s+Blur\s+Bubbles
          """, re.S | re.X)

          replacement = r"""
              // Real Blur Bubbles (RenderEffect, Android 12+)
              boolean blurDrawn = false;
              if (BlurBubbleConfig.blurEnabled && getParent() instanceof View && currentBackgroundDrawable != null) {
                  View parentView = (View) getParent();
                  boolean isOutgoing = currentMessageObject != null && currentMessageObject.isOutOwner();
                  boolean shouldBlur = isOutgoing ? BlurBubbleConfig.shouldBlurOutgoing() : BlurBubbleConfig.shouldBlurIncoming();
                  if (shouldBlur) {
                      Rect bounds = currentBackgroundDrawable.getBounds();
                      int absLeft = bounds.left + (int) getX();
                      int absTop  = bounds.top  + (int) getY();
                      blurDrawn = RealBlurBubbleHelper.drawBlurIntoBubble(
                          canvas,
                          parentView,
                          bounds,
                          absLeft,
                          absTop,
                          currentBackgroundDrawable
                      );
                  }
              }
              // End Real Blur Bubbles
          """

          s2, n = pattern.subn(replacement, s, count=1)
          if n == 0:
              raise SystemExit("Could not find the Nekogram blur block to replace. (Marker comments not found)")

          p.write_text(s2, encoding="utf-8")
          print("Patched ChatMessageCell.java OK")
          PY

          # 5) Patch bubble draw alpha when blurDrawn == true
          python3 - <<'PY'
          import re, pathlib

          p = pathlib.Path("TMessagesProj/src/main/java/org/telegram/ui/Cells/ChatMessageCell.java")
          s = p.read_text(encoding="utf-8")

          # Find the place where currentBackgroundDrawable alpha is set and drawCached happens (in the same block we saw)
          # We'll inject: if (blurDrawn) alphaInternal *= BlurBubbleConfig.getOverlayAlpha();
          anchor = "currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));"
          if anchor not in s:
              raise SystemExit("Anchor not found for background alpha set.")

          # Only inject once, in the draw background block
          s = s.replace(
              "currentSelectedBackgroundAlpha = 0;\n                 currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));",
              "currentSelectedBackgroundAlpha = 0;\n                 if (blurDrawn) {\n                     alphaInternal *= BlurBubbleConfig.getOverlayAlpha();\n                 }\n                 currentBackgroundDrawable.setAlpha((int) (255 * alphaInternal));",
              1
          )

          p.write_text(s, encoding="utf-8")
          print("Injected overlay alpha OK")
          PY

      - name: Build APK (afatRelease)
        shell: bash
        run: |
          set -euxo pipefail
          ./gradlew --no-daemon :TMessagesProj_App:assembleAfatRelease

      - name: Collect APKs (universal + arm64)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p artifacts

          # Try common Telegram outputs
          # Universal:
          UNIVERSAL=$(ls -1 TMessagesProj_App/build/outputs/apk/afat/release/*.apk 2>/dev/null | head -n 1 || true)
          if [ -n "${UNIVERSAL}" ]; then
            cp "${UNIVERSAL}" "artifacts/TelegramBlur-universal.apk"
          fi

          # arm64 split (if produced)
          ARM64=$(ls -1 TMessagesProj_App/build/outputs/apk/afat/release/*arm64*/*.apk 2>/dev/null | head -n 1 || true)
          if [ -z "${ARM64}" ]; then
            ARM64=$(ls -1 TMessagesProj_App/build/outputs/apk/afat/release/*arm64*.apk 2>/dev/null | head -n 1 || true)
          fi
          if [ -n "${ARM64}" ]; then
            cp "${ARM64}" "artifacts/TelegramBlur-arm64-v8a.apk"
          fi

          echo "Artifacts:"
          ls -lah artifacts || true

      - name: Upload universal APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TelegramBlur-universal
          path: artifacts/TelegramBlur-universal.apk
          if-no-files-found: warn

      - name: Upload arm64 APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TelegramBlur-arm64-v8a
          path: artifacts/TelegramBlur-arm64-v8a.apk
          if-no-files-found: warn
